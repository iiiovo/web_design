<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>栖居</title>
    <!-- CSS dependencies -->
    <link rel="stylesheet" href="static/css/all.css" type="text/css" />
    <link rel="stylesheet" href="static/css/wireframe.css" />
    <link rel="stylesheet" href="static/scss/theme.css" />
    <link
      rel="stylesheet"
      href="https://cdn.bootcss.com/font-awesome/5.8.2/css/fontawesome.min.css"
      type="text/css"
    />
    <style>
      [hidden] {
        visibility: hidden;
      }
      a:link {
        text-decoration: none;
      }
      
      @font-face {
        font-family: qiju;
        src: url('https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/fonts/CYHLSFT.ttf');
      }
      a.knowmore {
        text-transform: uppercase;
        letter-spacing: 0.07rem;
        color: white !important;
        height: 37px;
        display: block;
        overflow: hidden;
        background-repeat: no-repeat;
        -webkit-transition: all 0.3s;
        transition: all 0.3s;
        line-height: 20px;
      }
      a.knowmore:link {
        text-decoration: none;
      }
      a.knowmore:hover,
      a.knowmore:focus {
        color: black !important;
        padding: 5px 5px 5px 5px;
        background-color: #fff;
      }
      #cat div{
       display:none;
      }
      #cat:hover div{
       display:initial;
      }
    </style>
<body>
  <div
      class="in collapse"
      style="background-image: url(https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/img/dynamic-style.png);"
      id="navbarHeader"
    >
      <div class="container">
        <div class="row">
          <div class="py-4 col-md-3">
            <a id="switchLoginOrLogout" href="user/login.html" class="text-decoration-none">
              <h2>登录</h2>
              <h5>点这里~</h5>
            </a>
          </div>
          <div id="userPageEnter" class="py-4 col-md-3" hidden>
            <a href="user/user_page.html" class="text-decoration-none">
              <h2>个人中心</h2>
              <h5>请先登录哦</h5>
            </a>
          </div>
          <div class="py-4 col-md-3">
            <a href="item/xianzhi.html" class="text-decoration-none">
              <h2>闲置物品</h2>
              <h5>便捷处理闲置物品</h5>
            </a>
          </div>
          <div class="col-md-3  py-4">
            <h2>关于我们</h2>
            <ul class="list-unstyled">
              <li class="shadow-none">
                <a href="#" class="text-decoration-none">官方微博</a>
              </li>
              <li class="">
                <a href="#" class="text-decoration-none">官方微信</a>
              </li>
              <li class="">
                <a href="#" class="text-decoration-none">官方邮箱</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div
      class="text-center text-md-right h-75 py-0"
      style="background-image: url('https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/img/living-room-5.jpg'); background-position: right bottom; background-size: cover; background-repeat: repeat; background-attachment: fixed;"
    >
      <div class="navbar">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <i class="d-block far fa-lg fa-building text-body"></i>
            <h1 style="font-family:qiju;" class="pb-0 mb-0">栖居</h1>
          </a>
          <button id="cat"
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarHeader"
            aria-expanded="true"
            
          >
            <img 
              url=""
              src="https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/gif/364.gif"
              width="50"
            />
            <div 
            style="position:relative;float:left;z-index:10;font-family:qiju;font-size: 22px;border-radius: 50%;" 
            class="text-black bg-light p-2" 
            >
            "迷路啦？点我点我~~~"<div>
          </button>
        </div>
      </div>
      <div class="container" style="margin-top:350px;">
        <div class="row" style="margin-left:100px;">
          <div class="col-md-12 ">
            <form class="form-inline mb-0" style="width:1100px">
              <div class="input-group w-75">
                <input
                  id="searchform"
                  type="text"
                  id="keyword"
                  class="form-control form-control-lg"
                  placeholder="关键词：地区，地点，设施等~"
                />
                <select id="box"> </select>
                <div class="input-group-append">
                  <button
                    class="btn btn-primary px-3"
                    type="button"
                    id="search"
                  >
                    搜 &nbsp; 索
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="col-md-12 mt-0 pt-0" style="z-index:8;">
            <div
              id="selectBox"
              style="width: 707px; height: 100px; background-color: white; display: none;"
              class="mt-0 py-0"
            >
              <ul style="list-style: none;" class="my-0" id="regionBox">
                <li style="float:left;" class="mr-3">地区</li>
                <li style="float:left;" class="mx-2">
                  <input type="checkbox" value="荣昌" /> 荣昌
                </li>
                <li style="float:left;" class="ml-3 mr-5">
                  <input type="checkbox" value="北碚" /> 北碚
                </li>
              </ul>
              <br />
              <ul style="list-style: none;" id="petBox" class="my-0">
                <li style="float:left;" class="mr-3">宠物</li>
                <li style="float:left;" class="mx-2">
                  <input type="checkbox" value="1" /> 可携
                </li>
                <li style="float:left;" class="ml-3 mr-5">
                  <input type="checkbox" value="0" /> 不可
                </li>
              </ul>
              <br />
              <ul style="list-style: none;" id="priceBox" class="my-0">
                <li style="float:left;" class="mr-3">价格</li>
                <li style="float:left;" class="mx-2">
                  <input type="checkbox" value="0,300" /> 0~300
                </li>
                <li style="float:left;" class="ml-2">
                  <input type="checkbox" value="300,500" /> 300~500
                </li>
                <li style="float:left;" class="ml-3">
                  <input type="checkbox" value="500,-1" /> 500以上
                </li>
              </ul>
              <br />
              <ul style="list-style: none;" id="facilityBox">
                <li style="float:left;" class="mr-3">设施</li>
                <li style="float:left;" class="mx-2">
                  <input type="checkbox" value="空调" /> 空调
                </li>
                <li style="float:left;" class="ml-3">
                  <input type="checkbox" value="无线" /> 无线
                </li>
                <li style="float:left;" class="ml-3">
                  <input type="checkbox" value="独卫" /> 独卫
                </li>
                <li style="float:left;" class="ml-3">
                  <input type="checkbox" value="书桌" /> 书桌
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="py-4"
      style="background-image: url(https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/img/dynamic-style.png);"
    >
      <div class="container ">
        <div class="row" id="searchShow" hidden>
          <div class="col-md-12">
            <h1 class="bg-secondary pl-2 pb-1">搜索结果</h1>
          </div>
        </div>

        <div id="paginationRow" class="row" hidden>
          <div class="col-md-12">
            <ul
              id="pagination"
              class="pagination pt-5"
              style="margin-left:41.5%;"
            >
              <li class="page-item">
                <a class="page-link" href="#"> <span>«</span></a>
              </li>
              <li class="page-item active">
                <a class="page-link" href="#">1</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item"><a class="page-link" href="#">4</a></li>
              <li class="page-item">
                <a class="page-link" href="#"> <span>»</span></a>
              </li>
            </ul>
          </div>
        </div>
        <div class="row" id="suggest">
          <div class="col-md-12">
            <h1 class="bg-secondary pl-2 pb-1" id="latest">最近上新</h1>
          </div>
        </div>
        <a data-toggle="modal" data-target=".white" href=""> </a>
      </div>
      <a data-toggle="modal" data-target=".white" href=""> </a>
    </div>
    <div
      class="py-4 bg-light"
      style="background-image: url(https://qiju-1252919816.cos.ap-chongqing.myqcloud.com/static/img/dynamic-style.png);"
    >
      <div class="container">
        <div id="topRecommand" class="row">
          <div class="col-md-12">
            <h1 class="bg-secondary pl-2 pb-1">精品推荐</h1>
          </div>
        </div>
        <a data-toggle="modal" data-target=".white" href=""> </a>
      </div>
      <div class="container">
        <!-- 分页 -->
      </div>
      <div class="container" style="margin-top:80px">
        <div class="row">
          <div class="col-md-12 text-center">
            <a>
              <p class="mb-1 h6 text-muted">© 2018-2019 发际线保卫队</p>
            </a>
            <ul class="list-inline text-muted">
              <a> </a>
              <li class="list-inline-item text-white">
                <a> </a><a href="#" class="text-info h6">Privacy</a>
              </li>
              <li class="list-inline-item">
                <a href="#" class="text-info h6">Terms</a>
              </li>
              <li class="list-inline-item">
                <a href="#" class="text-info h6">Support</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <footer class="text-muted">
      <div
        class="modal fade white"
        style="display: none;"
        aria-hidden="true"
        id="failCollect"
      >
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header bg-light">
              <h4 class="modal-title py-2 ml-2">
                <b>请先登陆再进行此操作: )</b>
              </h4>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">×</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <script src="https://g.alicdn.com/mui/jquery/4.0.1/jquery.js"></script>
  <script src="https://cdn.bootcss.com/popper.js/1.15.0/umd/popper.min.js"></script>
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
  <script src="/static/js/jq-paginator.min.js"></script>
  <script type="text/javascript">
    function renderHouses(containerCssSelector, thisHouse, dataBox) {
      var online = dataBox.online;
      var price_discuss = thisHouse.price_discuss ? "可议价" : "不可议价"
        $(containerCssSelector).append(`<div class="col-md-4 p-3">
          <div class="card box-shadow"> <a ${online ? '' : 'data-toggle="modal" data-target="#failCollect"'} href="house/onehouse.html#/page/${thisHouse.house_id}" class="text-decoration-none">
              <img class="card-img-top" src="${thisHouse.house_image[0]}" height="220px">
              <div class="card-body pt-1 pb-1"> 
              <h5>${thisHouse.address}</h5>
              <i class="fas fa-jpy d-inline"><h7>${thisHouse.price}</h7><h7>（${price_discuss}）</h7></i>
              <!--<div class="align-items-center d-flex mb-1">
              <button data-id="${thisHouse.house_id}" onclick="toKonwMore(this)" class="fa bg-secondary mr-5 mt-2 py-1 px-1 know-more" type="button" class="fa bg-secondary mr-5 mt-2 py-1 px-1"> Know more</button>-->
              </a>
              <div class="col-md-6 mt-2 mb-0 pl-1 pr-4 pt-1"><b>收藏数：${thisHouse.collect_times || 0}</b></div>
              <div class="pb-1 row">
                  <div class="col-md-6 mt-2 mb-0 pl-2 pr-4"><a ${online ? '' : 'data-toggle="modal" data-target="#failCollect"'} class="btn btn-primary knowmore px-1" href="house/onehouse.html#/page/${thisHouse.house_id}">
                  <p style="margin-top:1px;">知道更多</p>
                </a></div>
              <div class="col-md-6 my-2"><a data-id="${thisHouse.house_id}" class="btn btn-primary ml-5 mr-2 knowmore" onclick="toCollectHouse(this)"  ${online ? '' : 'data-toggle="modal" data-target="#failCollect"'}>
              <i class="collect fa-star fa-fw fa-1x ${thisHouse.house_collect_status ? 'fas' : 'far'}" style="margin-top:4px;"></i></a></div>
              <!--<button type="button" data-id="${thisHouse.house_id}" class="btn btn-primary ml-5 " onclick="toCollectHouse(this)"><i class="collect fa-star fa-1x fa-fw py-1 ${thisHouse.house_collect_status ? 'fas' : 'far'}"></i></button>-->
              <!-- <button data-id="${thisHouse.house_id}" onclick="toCollectHouse(this)" type="button" class="${thisHouse.house_collect_status ? 'fas' : 'far'} fa-star py-1 px-2 bg-secondary ml-4 mt-2 collect"></button>-->
              </div>
            </div>
          </div>`);
  }
        //-----------------------房源收藏js----------------------//
        function toCollectHouse(ele) {
      axios
        .post('/qiju/user/collectHouse', {
          house_id: ele.dataset.id
        })
        .then(function(response) {
          console.log(response);
          // 未登录
          if (
            response.data.code === -1 &&
            response.data.message === '需要验证'
          ) {
            //若用户未登录，不允许进行收藏操作，但允许浏览。跳转至登录界面
           // alert('Ooh,请先登录再操作哦');
            $('#failCollect').modal('show'); //failCollect对应弹框无效操作提醒弹框的id
            setTimeout(function() {
              $('#failCollect').modal('hide');
              location.href = 'user/login.html';
            }, 1500);
            return;
          }
          // 已登录
          // 切换收藏状态
          if (response.data.code === 1) {
            var thisHouseCollect = $(ele).find('i');
            if (thisHouseCollect.hasClass('far')) {
              thisHouseCollect.removeClass('far').addClass('fas');
            } else {
              thisHouseCollect.removeClass('fas').addClass('far');
            }
          }
        })
        .catch(function(error) {
          console.log(error);
        });
    }
</script>
<script type="text/javascript">
  // 点击 Konw More的操作
 
  function toKonwMore(ele) {
    // 房子id
    alert(ele.dataset.id);
  }
  //登录登出切换
  axios.get('/qiju/user/online').then(function(res) {
    if (res.data.code === 1) {
      // var online = res.data.data.online;
      var nav = $('.navigator');
      // if (online) {
      var switchLoginOrLogout = $('#switchLoginOrLogout');
      switchLoginOrLogout.removeAttr('href');
      switchLoginOrLogout.css({ cursor: 'pointer' });
      switchLoginOrLogout.find('h2').html('登出');
      switchLoginOrLogout.click(function () {
        axios.get('/qiju/user/logout').then(resp => {
          if (resp.data.code === 1) {
            // 提示已登出
            // alter("登出成功");
            setTimeout(() => {
              window.location.reload();
            }, 210);
            // //隐藏个人中心
            //   nav.removeClass('col-md-3').addClass('col-md-4');
            //   $('#userCenter').hide();
          }
        })
      });
      $('#userPageEnter').removeAttr('hidden');
    }
      
    }).catch(function(error) {
      console.log(error);
    });
  
   axios.get('/qiju/house/markedRank').then(function(res) {
     console.log(res.data);
    
    if (res.data.code === 1) {
      //渲染数据
      var houseList = res.data.data.list;
      var online = res.data.data.online;
      var length = houseList.length;
      for (var i = 0; i < length; i++) {
        var thisHouse = houseList[i];
        // 渲染数据
        renderHouses('#topRecommand.row', thisHouse, {  online: res.data.data.online });
      }
    }
   });
    // "最近上新"
    //获取后端传来的数据数组
    axios
      .get('/qiju/house/recent')
      .then(function(res) {
        if (res.data.code === 1) {
          //渲染数据
          var houseList = res.data.data.list;
          var length = houseList.length;
          for (var i = 0; i < length; i++) {
            var thisHouse = houseList[i];
            renderHouses('#suggest.row', thisHouse, {
              online: res.data.data.online
            });
          }
        } else {
          // alter('暂无数据');
        }
      })
      .catch(function(error) {
        console.log(error);
      });
  </script>
  <!--下拉框样式js-->
  <script>
    //var arr = []; //定义一个数组用来接收多选框的值
    //初始化让下拉列表不显示
    $(function() {
      $('#selectBox').hide();
    });
    //单击下拉列表时显示/隐藏下拉列表
    $('#box').click(function() {
      $('#selectBox').toggle();
    });
    $('#searchform').click(function() {
      $('#selectBox').toggle();
      
    });
    
    //前三项复选框单选限制
    //勾记复选框传值至搜索框中
    $(function() {
      var regionBox = $('#regionBox input:checkbox');
      var petBox = $('#petBox input:checkbox');
      var priceBox = $('#priceBox input:checkbox');
      var fancilityBox = $('#fancilityBox input:checkbox');
      regionBox.click(function() {
        if (this.checked || this.checked == 'checked') {
          $('#regionBox')
            .find('input[type=checkbox]')
            .not(this)
            .attr('checked', false);
        }});
      
      petBox.click(function() {
        if (this.checked || this.checked == 'checked') {
          $('#petBox')
            .find('input[type=checkbox]')
            .not(this)
            .attr('checked', false);
        }
      });
      priceBox.click(function() {
        if (this.checked || this.checked == 'checked') {
          $('#priceBox')
            .find('input[type=checkbox]')
            .not(this)
            .attr('checked', false);
        }
      });
      $('#selectBox input').change(function() {
        var result = '';
        $('input:checked').each(function() {
          result += $(this).val() + ',';
        });
        if (result != '') {
          result = result.substring(0, result.lastIndexOf(','));
        }
        $('#keyword').val(result);
      });
    });
    var allSelectBox = $('#selectBox input[type=checkbox]');
    var searchType = 'keyword';
    var conditionSearchData = {
      region: null,
      pet: null,
      price: null,
      facility: []
    };
    var pageNum = 1;
    function refreshType() {
      var flag = 0;
      allSelectBox.each(function() {
        if ($(this).prop('checked')) {
          flag = 1;
        }
      });
      if (flag) {
        searchType = 'condition';
      } else {
        searchType = 'keyword';
      }
    }
    $('#keyword').val('');
    // !!!需要
    allSelectBox.removeAttr('checked');
    refreshType();
    function keywordOrConditionSearch() {
      $('#searchShow').removeAttr('hidden');
      $('#paginationRow').removeAttr('hidden');
      if (searchType === 'keyword') {
        axios
          .get('/qiju/house/houseSearch', {
            params: {
              keyword: $('#keyword').val(),
              page: pageNum
            }
          })
          .then(function(res) {
            if (res.data.code === 1) {
              // 清空
              $('#searchShow.row').html(`
        <div class="col-md-12">
          <h1 class="bg-secondary pl-2 pb-1">搜索结果</h1>
        </div>`);
              //渲染
              var houseList = res.data.data.list;
              var length = houseList.length;
              if (length === 0) {
                // 更新为空的样式
                $('#searchShow.row').append(`
        <div class="col-md-12">
          <h1 class="pl-2 pb-1">结果为空</h1>
        </div>`);
              }
              for (var i = 0; i < length; i++) {
                var thisHouse = houseList[i];
                renderHouses('#searchShow.row', thisHouse, {
                  online: res.data.data.online
                });
              }
            } else {
              // alter('暂无数据');
            }
          });
      } else if (searchType === 'condition') {
        // var data =
        axios
          .post(
            '/qiju/house/conditionSearch',
            Object.assign({}, conditionSearchData, { page: pageNum })
          )
          .then(function(res) {
            if (res.data.code === 1) {
              // 清空
              $('#searchShow.row').html(`
        <div class="col-md-12">
          <h1 class="bg-secondary pl-2 pb-1">搜索结果</h1>
        </div>`);
              //渲染
              var houseList = res.data.data.list;
              var length = houseList.length;
              if (length === 0) {
                // 更新为空的样式
                $('#searchShow.row').append(`
        <div class="col-md-12">
          <h1 class="pl-2 pb-1">结果为空</h1>
        </div>`);
              }
              for (var i = 0; i < length; i++) {
                var thisHouse = houseList[i];
                renderHouses('#searchShow.row', thisHouse, {
                  online: res.data.data.online
                });
              }
            } else {
              // alter('暂无数据');
            }
          });
      }
    }
    // 值绑定
    $('#regionBox input[type=checkbox]').change(function() {
      setTimeout(() => {
        if ($(this).prop('checked')) {
          conditionSearchData.region = $(this).val();
          return;
        }
        conditionSearchData.region = null;
      }, 500);
    });
    // 值绑定
    $('#petBox input[type=checkbox]').change(function() {
      setTimeout(() => {
        if ($(this).prop('checked')) {
          conditionSearchData.pet = $(this).val();
          return;
        }
        conditionSearchData.pet = null;
      }, 500);
    });
    // 值绑定
    $('#priceBox input[type=checkbox]').change(function() {
      setTimeout(() => {
        if ($(this).prop('checked')) {
          conditionSearchData.price = $(this).val();
          return;
        }
        conditionSearchData.price = null;
      }, 500);
    });
    // 值绑定
    $('#facilityBox input[type=checkbox]').change(function() {
      setTimeout(() => {
        if ($(this).prop('checked')) {
          conditionSearchData.facility.push($(this).val());
        } else {
          conditionSearchData.facility.splice(
            conditionSearchData.facility.indexOf($(this).val()),
            1
          );
        }
      }, 500);
    });
    allSelectBox.click(function(params) {
      refreshType();
    });
    $('#keyword').keypress(function(e) {
      if (e.keyCode === 13) {
        keywordOrConditionSearch();
        e.preventDefault();
        return false;
      }
    });
    $('#keyword').keyup(function(e) {
      // console.log($(this).val(), e.keyCode);
      if (e.keyCode > 7) {
        allSelectBox.removeAttr('checked');
        refreshType();
      }
    });
    $('#pagination').jqPaginator({
      totalPages: 100,
      visiblePages: 5,
      currentPage: 1,
      // first: '',
      prev:
        '<li class="page-item"> <a class="page-link"> <span>«</span></a> </li>',
      next:
        '<li class="page-item"> <a class="page-link"> <span>»</span></a> </li>',
      // last: '<li class="last"><a href="javascript:void(0);">Last</a></li>',
      page: '<li class="page-item"> <a class="page-link">{{page}}</a> </li>',
      onPageChange: function(num) {
        pageNum = num;
        // 如果不是第一次进入页面，则刷新数据
        if ($('#searchShow').attr('hidden') !== 'hidden') {
          keywordOrConditionSearch();
        }
      }
    });
    $('#search').click(function() {
      keywordOrConditionSearch();
    });
  </script>
  </body>
</html>
